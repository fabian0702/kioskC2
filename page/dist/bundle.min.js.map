{"version":3,"file":"bundle.min.js","sources":["../src/communication_plugin.js","../src/websocket_plugin.js","../src/script.js"],"sourcesContent":["var plugins = [];\nvar on_message_callbacks = [];\nvar plugin_send_function = null;\nvar active_plugin = null;\n\nclass CommuncationPlugin {\n    name;\n    on_msg_callback;\n    on_msg(_callback) {\n        throw new Error(\"CommuncationPlugin.on_msg() must be overridden by a child class\");\n    }\n\n    send(_data) {\n        throw new Error(\"CommuncationPlugin.send() must be overridden by a child class\");\n    }\n\n    teardown() {\n        console.log(`Tearing down communication plugin: ${this.name}`);\n    }\n}\n\nfunction register_communication_plugin(plugin) {\n    console.log(\"Registering communication plugin:\", plugin.name);\n\n    if (typeof plugin !== \"function\" || !(plugin.prototype instanceof CommuncationPlugin)) {\n        throw new Error(\"Plugin must be a class that extends CommuncationPlugin\");\n    }\n\n    plugins.push(plugin);\n}\n\nfunction find_plugin() {\n    for (const PluginClass of plugins) {\n        try {\n            const plugin_instance = new PluginClass();\n            console.log(`Established communication with plugin: ${PluginClass.name}`);\n            return plugin_instance;\n        } catch (err) {\n            console.error(`Failed to establish communication with plugin: ${PluginClass.name}`, err);\n        }\n    }\n}\n\nfunction establish_communication() {\n    console.log(\"Establishing communication...\");\n    active_plugin = find_plugin();\n    if (!active_plugin) {\n        throw new Error(\"No communication plugin could be established\");\n    }\n\n    active_plugin.on_msg((msg) => {\n        console.log(\"Received message:\", msg);\n        let operation = msg?.operation;\n        let data = msg?.data;\n\n        try {\n            if (typeof msg === \"string\") {\n                msg = JSON.parse(msg);\n                operation = msg.operation;\n                data = msg.data;\n            }\n        } catch (err) {\n            console.error(\"Failed to parse incoming message as JSON:\", msg, err);\n            return;\n        }\n\n        if (!operation) {\n            console.error(\"Received message without operation:\", msg);\n            return;\n        }\n        const callbacks = on_message_callbacks[operation] || [];\n        if (callbacks.length === 0) {\n            console.warn(`No callbacks registered for operation: ${operation}`);\n            return;\n        }\n        callbacks.forEach((callback) => callback(data));\n    });\n\n    plugin_send_function = active_plugin.send.bind(active_plugin);\n\n    return active_plugin;\n}\n\nfunction send_message(data) {\n    if (!plugin_send_function) {\n        throw new Error(\"Communication plugin not established\");\n    }\n    plugin_send_function(data);\n}\n\nfunction register_message_callback(operation, callback) {\n    if (!on_message_callbacks[operation]) {\n        on_message_callbacks[operation] = [];\n    }\n    on_message_callbacks[operation].push(callback);\n}\n\nfunction teardown_communication() {\n    active_plugin.teardown();\n    active_plugin = null;\n    plugin_send_function = null;\n    on_message_callbacks = [];\n}\n\nexport {\n    CommuncationPlugin, \n    register_communication_plugin,\n    establish_communication,\n    teardown_communication,\n    send_message,\n    register_message_callback,\n};","import { CommuncationPlugin, register_communication_plugin } from './communication_plugin.js';\n\nclass WebsocketPlugin extends CommuncationPlugin {\n    ws;\n    ws_ready_promise;\n    name = \"WebsocketPlugin\";\n    constructor() {\n        super();\n\n        this.ws = new WebSocket(`ws://${window.location.host}/ws`);\n\n        this.ws_ready_promise = new Promise((resolve, reject) => {\n            this.ws.addEventListener(\n                \"open\",\n                () => {\n                    console.log(\"WebsocketPlugin: Connected to WebSocket\");\n                    resolve();\n                },\n                { once: true }\n            );\n\n            this.ws.addEventListener(\n                \"error\",\n                (err) => {\n                    console.error(\"WebsocketPlugin: WebSocket error\", err);\n                    reject(err);\n                },\n                { once: true }\n            );\n        });\n    }\n    on_msg(_callback) {\n        if (!this.ws || _callback === null) {\n            throw new Error(\"WebsocketPlugin: WebSocket not initialized or callback is null\");\n        }\n        this.ws.addEventListener(\"message\", (event) => {\n            _callback(event.data);\n        });\n    }\n\n    send(data) {\n        if (!this.ws || !this.ws_ready_promise) {\n            console.warn(\"WebsocketPlugin: WebSocket not initialized\");\n            return;\n        }\n        this.ws_ready_promise\n            .then(() => {\n                const payload = typeof data === \"string\" ? data : JSON.stringify(data);\n                this.ws.send(payload);\n            })\n            .catch((err) => {\n                console.error(\"WebsocketPlugin: Failed to send message, WebSocket not ready\", err);\n            });\n    }\n\n    teardown() {\n        console.log(`Tearing down communication plugin: ${this.name}`);\n        if (this.ws) {\n            this.ws.close();\n            this.ws = null;\n        }\n        if (this.ws_ready_promise) {\n            this.ws_ready_promise = null;\n        }\n    }\n}\n\nregister_communication_plugin(WebsocketPlugin);","import { teardown_communication, establish_communication, send_message, register_message_callback } from \"./communication_plugin.js\";\n\nimport \"./example_plugin.js\";\nimport \"./websocket_plugin.js\";\n\nconst heartbeat_interval = 2000;\nconst heartbeat_timeout = 2*heartbeat_interval;\n\nfunction setup_heartbeat_monitor() {\n    var last_heartbeat = null;\n\n    register_message_callback(\"heartbeat\", (data) => {\n        console.log(\"Received heartbeat:\", data);\n        last_heartbeat = Date.now();\n    });\n\n    setInterval(() => {\n        send_message({ operation: \"heartbeat\", data: \"ping\" });\n        if (last_heartbeat && Date.now() - last_heartbeat > heartbeat_timeout) {\n            console.error(\"Heartbeat timeout: No heartbeat received in the last\", heartbeat_timeout, \"ms\");\n            teardown_communication();\n\n            console.warn(\"Re-establishing communication...\");\n            \n            establish_communication();\n        }\n    }, heartbeat_interval);\n}\n\nfunction setupPluginLoader() {\n    register_message_callback(\"load_plugin\", (url) => {\n        console.log(\"Received load_plugin message:\", url);\n        const script = document.createElement(\"script\");\n        script.src = url;\n        script.onload = () => {\n            console.log(`Plugin script loaded: ${url}`);\n            send_message({ operation: \"plugin_loaded\", data: url });\n        };\n        document.head.appendChild(script);\n    });\n}\n\nfunction setupJsEval() {\n    register_message_callback(\"eval_js\", (code) => {\n        console.log(\"Received eval_js message\");\n\n        var result = null;\n\n        try {\n            result = eval(code);\n        } catch (err) {\n            result = err.toString();\n            console.error(\"Error evaluating JS code:\", err);\n        }\n\n        if (typeof result != \"string\") {\n            try {\n                result = JSON.stringify(result || null);\n                console.log(\"Eval result serialized to JSON\" + result);\n            } catch (err) {\n                result = `Unserializable result: ${err.toString()}`;\n            }\n        }\n\n        send_message({ operation: \"eval_result\", data: result });\n    });\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n    establish_communication();\n\n    setup_heartbeat_monitor();\n    \n    setupPluginLoader();\n    setupJsEval();\n});"],"names":["plugins","on_message_callbacks","plugin_send_function","active_plugin","CommuncationPlugin","name","on_msg_callback","on_msg","_callback","Error","send","_data","teardown","register_communication_plugin","plugin","prototype","push","find_plugin","PluginClass","err","establish_communication","msg","operation","data","JSON","parse","callbacks","length","forEach","callback","bind","send_message","register_message_callback","teardown_communication","WebsocketPlugin","ws","ws_ready_promise","constructor","super","this","WebSocket","window","location","host","Promise","resolve","reject","addEventListener","once","event","then","payload","stringify","catch","close","heartbeat_interval","heartbeat_timeout","setup_heartbeat_monitor","last_heartbeat","Date","now","setInterval","setupPluginLoader","url","script","document","createElement","src","onload","head","appendChild","setupJsEval","code","result","eval","toString"],"mappings":"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"}