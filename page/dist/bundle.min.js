(function(){"use strict";var plugins=[],on_message_callbacks=[],plugin_send_function=null,active_plugin=null;class CommuncationPlugin{name;on_msg_callback;on_msg(e){throw new Error("CommuncationPlugin.on_msg() must be overridden by a child class")}send(e){throw new Error("CommuncationPlugin.send() must be overridden by a child class")}teardown(){}}function register_communication_plugin(e){if("function"!=typeof e||!(e.prototype instanceof CommuncationPlugin))throw new Error("Plugin must be a class that extends CommuncationPlugin");plugins.push(e)}function find_plugin(){for(const e of plugins)try{return new e}catch(e){}}function establish_communication(){if(!(active_plugin=find_plugin()))throw new Error("No communication plugin could be established");return active_plugin.on_msg(e=>{let n=e?.operation,t=e?.data;try{"string"==typeof e&&(n=(e=JSON.parse(e)).operation,t=e.data)}catch(e){return}if(!n)return;const s=on_message_callbacks[n]||[];0!==s.length&&s.forEach(e=>e(t))}),plugin_send_function=active_plugin.send.bind(active_plugin),active_plugin}function send_message(e){if(!plugin_send_function)throw new Error("Communication plugin not established");plugin_send_function(e)}function register_message_callback(e,n){on_message_callbacks[e]||(on_message_callbacks[e]=[]),on_message_callbacks[e].push(n)}function teardown_communication(){active_plugin.teardown(),active_plugin=null,plugin_send_function=null,on_message_callbacks=[]}class WebsocketPlugin extends CommuncationPlugin{ws;ws_ready_promise;name="WebsocketPlugin";constructor(){super(),this.ws=new WebSocket(`ws://${window.location.host}/ws`),this.ws_ready_promise=new Promise((e,n)=>{this.ws.addEventListener("open",()=>{e()},{once:!0}),this.ws.addEventListener("error",e=>{n(e)},{once:!0})})}on_msg(e){if(!this.ws||null===e)throw new Error("WebsocketPlugin: WebSocket not initialized or callback is null");this.ws.addEventListener("message",n=>{e(n.data)})}send(e){this.ws&&this.ws_ready_promise&&this.ws_ready_promise.then(()=>{const n="string"==typeof e?e:JSON.stringify(e);this.ws.send(n)}).catch(e=>{})}teardown(){this.ws&&(this.ws.close(),this.ws=null),this.ws_ready_promise&&(this.ws_ready_promise=null)}}register_communication_plugin(WebsocketPlugin);const heartbeat_interval=2e3,heartbeat_timeout=2*heartbeat_interval;function setup_heartbeat_monitor(){var e=null;register_message_callback("heartbeat",n=>{e=Date.now()}),setInterval(()=>{send_message({operation:"heartbeat",data:"ping"}),e&&Date.now()-e>heartbeat_timeout&&(teardown_communication(),establish_communication())},heartbeat_interval)}function setupPluginLoader(){register_message_callback("load_plugin",e=>{const n=document.createElement("script");n.src=e,n.onload=()=>{send_message({operation:"plugin_loaded",data:e})},document.head.appendChild(n)})}function setupJsEval(){register_message_callback("eval_js",code=>{var result=null;try{result=eval(code)}catch(e){result=e.toString()}if("string"!=typeof result)try{result=JSON.stringify(result||null)}catch(e){result=`Unserializable result: ${e.toString()}`}send_message({operation:"eval_result",data:result})})}document.addEventListener("DOMContentLoaded",()=>{establish_communication(),setup_heartbeat_monitor(),setupPluginLoader(),setupJsEval()})})();
//# sourceMappingURL=bundle.min.js.map
